<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CI/CD pipeline for Rails 8 with Github Actions and Kamal | Hassen Taidirt</title>
<meta name=keywords content="DevOps,Docker,Ruby on Rails"><meta name=description content="Creating a robust yet simple CI/CD pipeline for Rails 8"><meta name=author content="Hassen"><link rel=canonical href=http://localhost:1313/posts/2024/06/ci-cd-for-rails-8-github-actions-kamal/><meta name=google-site-verification content="G-CBM4L789H1"><link crossorigin=anonymous href=/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/apple-touch-icon.png><link rel=mask-icon href=http://localhost:1313/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/2024/06/ci-cd-for-rails-8-github-actions-kamal/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="http://localhost:1313/posts/2024/06/ci-cd-for-rails-8-github-actions-kamal/"><meta property="og:site_name" content="Hassen Taidirt"><meta property="og:title" content="CI/CD pipeline for Rails 8 with Github Actions and Kamal"><meta property="og:description" content="Creating a robust yet simple CI/CD pipeline for Rails 8"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-22T08:01:15+01:00"><meta property="article:modified_time" content="2024-10-22T08:01:15+01:00"><meta property="article:tag" content="DevOps"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Ruby on Rails"><meta name=twitter:card content="summary"><meta name=twitter:title content="CI/CD pipeline for Rails 8 with Github Actions and Kamal"><meta name=twitter:description content="Creating a robust yet simple CI/CD pipeline for Rails 8"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"CI/CD pipeline for Rails 8 with Github Actions and Kamal","item":"http://localhost:1313/posts/2024/06/ci-cd-for-rails-8-github-actions-kamal/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"CI/CD pipeline for Rails 8 with Github Actions and Kamal","name":"CI\/CD pipeline for Rails 8 with Github Actions and Kamal","description":"Creating a robust yet simple CI/CD pipeline for Rails 8","keywords":["DevOps","Docker","Ruby on Rails"],"articleBody":"\nHello world!\nHave a reliable CI/CD pipeline is life changing. In this post, I share my notes on how to create a robust, yet simple, CI/CD pipeline for Ruby on Rails 8, using Github Actions and Kamal for deployment.\nOur goal Let’s walk through the steps required to set up a continuous integration and continuous deployment (CI/CD) pipeline for a Ruby on Rails 8 application.\nWe will leverage Github Actions for automating our workflows and Kamal for seamless deployment.\nBy the end of this guide, you will have a clear understanding of how to create a robust and simple CI/CD pipeline that ensures your Rails application is tested, built, and deployed efficiently.\nBut remember, every system is different, so adapt to your use case if my solution doesn’t fit your requirements. Use this guide as a v0.1 rather than just a Copy/Paste. In doubt, check Stack Overflow or ask an LLM.\nWhy Github Actions? If I have choice on the pipeline engine, I always choose Github Actions, mostly for the following reasons:\nAlready integrate into Github (where 99% of my codebase is) Has a generous free tier Very nice paradigms and easy to get started with Honestly, any CI/CD tool will do the job. So pick the one you like or the one your company requires to use. But if you don’t have an opinion yet, starting your DevOps journey with Github Actions is not a bad decision.\nBut the real question is: Why use a CI/CD tool? After all, Kamal deployments can be done manually from your command line. So why bother with incorporating this into another system?\nSimply put: Humans make errors.\nBy using automated tools, you ensure you’ll always run the same procedure no matter what. With a simple git push rather than a kamal deploy command.\nAlso, if you’re within a team, centralizing your deployment tools within your Git repository is a smart choice to avoid conflicts on deploys (plus a ton of other Ops scenarios that can make your day a nightmare).\n“Set it once, run forever” is what you should aim for, wether you’re a team of 1 or 10. Wether you’re an intern or the CTO.\nAutomating deployments is tasting freedom ®\nWhy Kamal? Even though there are a ton of other deployments alternatives, Kamal is now encapsulated by default with new Rails 8 projects. And this is not a bad decision: It is a robust tool, used by 37Signals so you can be confident it will be well maintained, and is very easy to use (when setup properly).\nPlus, everything that configures Kamal is comitted into Git, which makes it a step forward GitOps approach (even though there are still some manuels steps like setting up a VPS and DNS stuff).\nAssumptions I’m assuming that you already have a Rails 8 application, with Kamal installed on your machine, a Github account, and a VPS already started and configured to allow SSH.\nOtherwise this post will become too big, and I don’t want to explicit basic setup steps that can quickly be outdated. Thank you.\nSetup Github Actions Github Actions are YAML files located in the .github/ folder of your project.\nCreate a file .github/workflows/deploy.yml\nname: Deploy onto Production on: push: branches: - master permissions: contents: read packages: write id-token: write jobs: deploy: if: github.event_name == 'push' \u0026\u0026 github.ref == 'refs/heads/master' runs-on: ubuntu-24.04 env: RAILS_ENV: production BUNDLE_WITH: tools BUNDLE_WITHOUT: \"development test\" DOCKER_BUILDKIT: 1 steps: - name: Checkout code uses: actions/checkout@v4 - name: Set up Ruby uses: ruby/setup-ruby@v1 with: ruby-version: .ruby-version bundler-cache: true - name: Set up Docker Buildx uses: docker/setup-buildx-action@v3 - name: Set up SSH run: | mkdir -p ~/.ssh echo \"$SSH_PRIVATE_KEY\" \u003e ~/.ssh/id_rsa chmod 600 ~/.ssh/id_rsa eval $(ssh-agent -s) ssh-add ~/.ssh/id_rsa ssh-keyscan ww.xx.yy.zz \u003e\u003e ~/.ssh/known_hosts env: SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }} - name: Deploy using Kamal run: bin/kamal deploy env: RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }} KAMAL_REGISTRY_PASSWORD: ${{ secrets.KAMAL_REGISTRY_PASSWORD }} POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }} Let me explain:\nThis deployment runs when we push new changes to the master branch (github.event_name == 'push' \u0026\u0026 github.ref == 'refs/heads/master') And the pipeline will run on Ubuntu 24.04 (latest, at this time of writing).\nWe set the global environment to production and set DOCKER_BUILDKIT=1 to have verbose Docker builds (useful in case of debugging pipeline issues).\nAll of this was the pipeline setup phase. Let’s now tackle the steps of the pipeline:\nFirst we get the code (though actions/checkout@v4) and setup Ruby in it (ruby/setup-ruby@v1).\nMake sure to have the file .ruby-version commited in your project. The pipeline will read the version in it to match your settings.\nThen we setup Docker’s advanced build capabilities, so our docker image gets built and available for Kamal.\nThen comes the SSH config in the step called Set up SSH. Here please ensure the value of ww.xx.yy.zz matches the IP address of your server.\nFinally we run the Kamal deploy command with the necessary environment variables. The two minimal variables are RAILS_MASTER_KEY and KAMAL_REGISTRY_PASSWORD. I’m also regerencing PostgreSQL variables, but it might not be necessary for you if you’re using SQLite for example.\nGithub Secrets Note that the last 2 previous steps involve using the ${{ secrets.XYZ }} syntax. Here we are referencing Github Secrets values. We need to set them before running the pipeline.\nUnder your repo settings, look for Secrets and variables then Actions then New repository secret.\nThen fill the appropriate values for the 4 environment variables in our example:\nSSH_PRIVATE_KEY Your server SSH private key RAILS_MASTER_KEY Your Rails master key KAMAL_REGISTRY_PASSWORD The Docker registry password POSTGRES_PASSWORD The database password (depends on your case) How it works Now on, when you push new code on your master branch, the pipeline triggers which will grab your latest changes, it setups SSH for secure access, then Kamal is triggered to make the deployment.\nNote that Kamal will build the docker image of your codebase within the pipeline, pushes it to the docker registry, SSH into your server, then pull the image to run the container.\nMost of the deployment process is done by Kamal. Your pipeline setup is just here to prepare the work for Kamal.\nThis is the most time consuming step. That’s why we have set BUNDLE_WITHOUT=\"development test\" which makes the bundling faster using only necessary production gems.\nTake away Even though it looks tedious, it is totally worth it. Setting up the CI/CD pipeline should be done carefully so the rest of your journey becomes much more enjoyable.\nHopefully you have seen the power of Kamal in this setup. If you decide to go with another CI/CD solution, most changes will be in the setup, but the kamal deploy step remains the same because that’s where the deployment action occurs.\nKamal has introduced an abstraction that frees us from specific pipeline tooling.\nNote that the suggested workflow only covers a simple deployment through a push to master. More professional CI/CD pipelines also includes testing, deployment to other environments, feature deployments, reporting,… etc. Please treat this manual as your starting point, and enjoy your journey into DevOps.\nSee you soon.\nHassen\n","wordCount":"1172","inLanguage":"en","datePublished":"2024-10-22T08:01:15+01:00","dateModified":"2024-10-22T08:01:15+01:00","author":{"@type":"Person","name":"Hassen"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/2024/06/ci-cd-for-rails-8-github-actions-kamal/"},"publisher":{"@type":"Organization","name":"Hassen Taidirt","logo":{"@type":"ImageObject","url":"http://localhost:1313/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Hassen.io (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Hassen.io</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">CI/CD pipeline for Rails 8 with Github Actions and Kamal</h1><div class=post-meta><span title='2024-10-22 08:01:15 +0100 +0100'>October 22, 2024</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1172 words&nbsp;·&nbsp;Hassen&nbsp;|&nbsp;<a href=https://github.com/HassenIO/hassen.io/posts/2024/06/ci-cd-for-rails-8-github-actions-kamal.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p><img alt="Pipes and cables on a wall" loading=lazy src=/2024/06/unsplash-pipes.jpg title="Photo by Khara Woods on Unsplash"></p><p>Hello world!</p><p>Have a reliable CI/CD pipeline is life changing. In this post, I share my notes on how to create a robust, yet simple, CI/CD pipeline for Ruby on Rails 8, using Github Actions and Kamal for deployment.</p><h2 id=our-goal>Our goal<a hidden class=anchor aria-hidden=true href=#our-goal>#</a></h2><p>Let&rsquo;s walk through the steps required to set up a continuous integration and continuous deployment (CI/CD) pipeline for a Ruby on Rails 8 application.</p><p>We will leverage Github Actions for automating our workflows and Kamal for seamless deployment.</p><p>By the end of this guide, you will have a clear understanding of how to create a robust and simple CI/CD pipeline that ensures your Rails application is tested, built, and deployed efficiently.</p><p>But remember, every system is different, so adapt to your use case if my solution doesn&rsquo;t fit your requirements. Use this guide as a v0.1 rather than just a Copy/Paste. In doubt, check Stack Overflow or ask an LLM.</p><h2 id=why-github-actions>Why Github Actions?<a hidden class=anchor aria-hidden=true href=#why-github-actions>#</a></h2><p>If I have choice on the pipeline engine, I always choose Github Actions, mostly for the following reasons:</p><ul><li>Already integrate into Github (where 99% of my codebase is)</li><li>Has a generous free tier</li><li>Very nice paradigms and easy to get started with</li></ul><p>Honestly, any CI/CD tool will do the job. So pick the one you like or the one your company requires to use. But if you don&rsquo;t have an opinion yet, starting your DevOps journey with Github Actions is not a bad decision.</p><p>But the real question is: Why use a CI/CD tool? After all, Kamal deployments can be done manually from your command line. So why bother with incorporating this into another system?</p><p>Simply put: <strong>Humans make errors.</strong></p><p>By using automated tools, you ensure you&rsquo;ll always run the same procedure no matter what. With a simple <code>git push</code> rather than a <code>kamal deploy</code> command.</p><p>Also, if you&rsquo;re within a team, centralizing your deployment tools within your Git repository is a smart choice to avoid conflicts on deploys (plus a ton of other Ops scenarios that can make your day a nightmare).</p><p><em>&ldquo;Set it once, run forever&rdquo;</em> is what you should aim for, wether you&rsquo;re a team of 1 or 10. Wether you&rsquo;re an intern or the CTO.</p><p>Automating deployments is tasting freedom ®</p><h2 id=why-kamal>Why Kamal?<a hidden class=anchor aria-hidden=true href=#why-kamal>#</a></h2><p>Even though there are a ton of other deployments alternatives, Kamal is now encapsulated by default with new Rails 8 projects. And this is not a bad decision: It is a robust tool, used by 37Signals so you can be confident it will be well maintained, and is very easy to use (when setup properly).</p><p>Plus, everything that configures Kamal is comitted into Git, which makes it a step forward GitOps approach (even though there are still some manuels steps like setting up a VPS and DNS stuff).</p><h2 id=assumptions>Assumptions<a hidden class=anchor aria-hidden=true href=#assumptions>#</a></h2><p>I&rsquo;m assuming that you already have a Rails 8 application, with Kamal installed on your machine, a Github account, and a VPS already started and configured to allow SSH.</p><blockquote><p>Otherwise this post will become too big, and I don&rsquo;t want to explicit basic setup steps that can quickly be outdated. Thank you.</p></blockquote><h2 id=setup-github-actions>Setup Github Actions<a hidden class=anchor aria-hidden=true href=#setup-github-actions>#</a></h2><p>Github Actions are YAML files located in the <strong>.github/</strong> folder of your project.</p><p>Create a file <strong>.github/workflows/deploy.yml</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy onto Production</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>push</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>branches</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>permissions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>contents</span><span class=p>:</span><span class=w> </span><span class=l>read</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>packages</span><span class=p>:</span><span class=w> </span><span class=l>write</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>id-token</span><span class=p>:</span><span class=w> </span><span class=l>write</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>deploy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>if</span><span class=p>:</span><span class=w> </span><span class=l>github.event_name == &#39;push&#39; &amp;&amp; github.ref == &#39;refs/heads/master&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-24.04</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>RAILS_ENV</span><span class=p>:</span><span class=w> </span><span class=l>production</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>BUNDLE_WITH</span><span class=p>:</span><span class=w> </span><span class=l>tools</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>BUNDLE_WITHOUT</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;development test&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>DOCKER_BUILDKIT</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Checkout code</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Set up Ruby</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>ruby/setup-ruby@v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ruby-version</span><span class=p>:</span><span class=w> </span><span class=l>.ruby-version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bundler-cache</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Set up Docker Buildx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>docker/setup-buildx-action@v3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Set up SSH</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      mkdir -p ~/.ssh
</span></span></span><span class=line><span class=cl><span class=sd>      echo &#34;$SSH_PRIVATE_KEY&#34; &gt; ~/.ssh/id_rsa
</span></span></span><span class=line><span class=cl><span class=sd>      chmod 600 ~/.ssh/id_rsa
</span></span></span><span class=line><span class=cl><span class=sd>      eval $(ssh-agent -s)
</span></span></span><span class=line><span class=cl><span class=sd>      ssh-add ~/.ssh/id_rsa
</span></span></span><span class=line><span class=cl><span class=sd>      ssh-keyscan ww.xx.yy.zz &gt;&gt; ~/.ssh/known_hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>SSH_PRIVATE_KEY</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.SSH_PRIVATE_KEY }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy using Kamal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>bin/kamal deploy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>RAILS_MASTER_KEY</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.RAILS_MASTER_KEY }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>KAMAL_REGISTRY_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.KAMAL_REGISTRY_PASSWORD }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.POSTGRES_PASSWORD }}</span><span class=w>
</span></span></span></code></pre></div><p>Let me explain:</p><p>This deployment runs when we push new changes to the master branch (<code>github.event_name == 'push' && github.ref == 'refs/heads/master'</code>) And the pipeline will run on Ubuntu 24.04 (latest, at this time of writing).</p><p>We set the global environment to <code>production</code> and set <code>DOCKER_BUILDKIT=1</code> to have verbose Docker builds (useful in case of debugging pipeline issues).</p><p>All of this was the pipeline setup phase. Let&rsquo;s now tackle the steps of the pipeline:</p><p>First we get the code (though <code>actions/checkout@v4</code>) and setup Ruby in it (<code>ruby/setup-ruby@v1</code>).</p><p>Make sure to have the file <code>.ruby-version</code> commited in your project. The pipeline will read the version in it to match your settings.</p><p>Then we setup Docker&rsquo;s advanced build capabilities, so our docker image gets built and available for Kamal.</p><p>Then comes the SSH config in the step called <strong>Set up SSH</strong>. Here please ensure the value of <code>ww.xx.yy.zz</code> matches the IP address of your server.</p><p>Finally we run the Kamal deploy command with the necessary environment variables. The two minimal variables are <code>RAILS_MASTER_KEY</code> and <code>KAMAL_REGISTRY_PASSWORD</code>. I&rsquo;m also regerencing PostgreSQL variables, but it might not be necessary for you if you&rsquo;re using SQLite for example.</p><h2 id=github-secrets>Github Secrets<a hidden class=anchor aria-hidden=true href=#github-secrets>#</a></h2><p>Note that the last 2 previous steps involve using the <code>${{ secrets.XYZ }}</code> syntax. Here we are referencing Github Secrets values. We need to set them before running the pipeline.</p><p>Under your repo settings, look for <strong>Secrets and variables</strong> then <strong>Actions</strong> then <strong>New repository secret</strong>.</p><p><img alt="Github Actions Secrets" loading=lazy src=/2024/06/github-actions-secrets.png title="Github Actions Secrets"></p><p>Then fill the appropriate values for the 4 environment variables in our example:</p><ul><li><code>SSH_PRIVATE_KEY</code> Your server SSH private key</li><li><code>RAILS_MASTER_KEY</code> Your Rails master key</li><li><code>KAMAL_REGISTRY_PASSWORD</code> The Docker registry password</li><li><code>POSTGRES_PASSWORD</code> The database password (depends on your case)</li></ul><h2 id=how-it-works>How it works<a hidden class=anchor aria-hidden=true href=#how-it-works>#</a></h2><p>Now on, when you push new code on your master branch, the pipeline triggers which will grab your latest changes, it setups SSH for secure access, then Kamal is triggered to make the deployment.</p><p>Note that Kamal will build the docker image of your codebase within the pipeline, pushes it to the docker registry, SSH into your server, then pull the image to run the container.</p><p>Most of the deployment process is done by Kamal. Your pipeline setup is just here to prepare the work for Kamal.</p><p>This is the most time consuming step. That&rsquo;s why we have set <code>BUNDLE_WITHOUT="development test"</code> which makes the bundling faster using only necessary production gems.</p><h2 id=take-away>Take away<a hidden class=anchor aria-hidden=true href=#take-away>#</a></h2><p>Even though it looks tedious, it is totally worth it. Setting up the CI/CD pipeline should be done carefully so the rest of your journey becomes much more enjoyable.</p><p>Hopefully you have seen the power of Kamal in this setup. If you decide to go with another CI/CD solution, most changes will be in the setup, but the <code>kamal deploy</code> step remains the same because that&rsquo;s where the deployment action occurs.</p><p>Kamal has introduced an abstraction that frees us from specific pipeline tooling.</p><p>Note that the suggested workflow only covers a simple deployment through a push to <code>master</code>. More professional CI/CD pipelines also includes testing, deployment to other environments, feature deployments, reporting,&mldr; etc. Please treat this manual as your starting point, and enjoy your journey into DevOps.</p><p>See you soon.</p><p>Hassen</p></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/devops/>DevOps</a></li><li><a href=http://localhost:1313/tags/docker/>Docker</a></li><li><a href=http://localhost:1313/tags/ruby-on-rails/>Ruby on Rails</a></li></ul><nav class=paginav><a class=next href=http://localhost:1313/posts/2024/10/spam-assassin-as-a-service/><span class=title>Next »</span><br><span>Spam Assassin as a Service</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share CI/CD pipeline for Rails 8 with Github Actions and Kamal on x" href="https://x.com/intent/tweet/?text=CI%2fCD%20pipeline%20for%20Rails%208%20with%20Github%20Actions%20and%20Kamal&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f06%2fci-cd-for-rails-8-github-actions-kamal%2f&amp;hashtags=DevOps%2cDocker%2cRubyonRails"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CI/CD pipeline for Rails 8 with Github Actions and Kamal on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f06%2fci-cd-for-rails-8-github-actions-kamal%2f&amp;title=CI%2fCD%20pipeline%20for%20Rails%208%20with%20Github%20Actions%20and%20Kamal&amp;summary=CI%2fCD%20pipeline%20for%20Rails%208%20with%20Github%20Actions%20and%20Kamal&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f06%2fci-cd-for-rails-8-github-actions-kamal%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CI/CD pipeline for Rails 8 with Github Actions and Kamal on reddit" href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f06%2fci-cd-for-rails-8-github-actions-kamal%2f&title=CI%2fCD%20pipeline%20for%20Rails%208%20with%20Github%20Actions%20and%20Kamal"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CI/CD pipeline for Rails 8 with Github Actions and Kamal on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f06%2fci-cd-for-rails-8-github-actions-kamal%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CI/CD pipeline for Rails 8 with Github Actions and Kamal on whatsapp" href="https://api.whatsapp.com/send?text=CI%2fCD%20pipeline%20for%20Rails%208%20with%20Github%20Actions%20and%20Kamal%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f06%2fci-cd-for-rails-8-github-actions-kamal%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CI/CD pipeline for Rails 8 with Github Actions and Kamal on telegram" href="https://telegram.me/share/url?text=CI%2fCD%20pipeline%20for%20Rails%208%20with%20Github%20Actions%20and%20Kamal&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f06%2fci-cd-for-rails-8-github-actions-kamal%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share CI/CD pipeline for Rails 8 with Github Actions and Kamal on ycombinator" href="https://news.ycombinator.com/submitlink?t=CI%2fCD%20pipeline%20for%20Rails%208%20with%20Github%20Actions%20and%20Kamal&u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f06%2fci-cd-for-rails-8-github-actions-kamal%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=http://localhost:1313/>Hassen Taidirt</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>