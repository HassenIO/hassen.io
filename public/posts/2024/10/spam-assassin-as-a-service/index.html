<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Spam Assassin as a Service | Hassen Taidirt</title>
<meta name=keywords content="API,docker"><meta name=description content="Making SpamAssassin available through an API"><meta name=author content="Hassen"><link rel=canonical href=http://localhost:1313/posts/2024/10/spam-assassin-as-a-service/><meta name=google-site-verification content="G-CBM4L789H1"><link crossorigin=anonymous href=/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/apple-touch-icon.png><link rel=mask-icon href=http://localhost:1313/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/2024/10/spam-assassin-as-a-service/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="http://localhost:1313/posts/2024/10/spam-assassin-as-a-service/"><meta property="og:site_name" content="Hassen Taidirt"><meta property="og:title" content="Spam Assassin as a Service"><meta property="og:description" content="Making SpamAssassin available through an API"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-10-22T08:01:15+01:00"><meta property="article:modified_time" content="2024-10-22T08:01:15+01:00"><meta property="article:tag" content="API"><meta property="article:tag" content="Docker"><meta name=twitter:card content="summary"><meta name=twitter:title content="Spam Assassin as a Service"><meta name=twitter:description content="Making SpamAssassin available through an API"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"Spam Assassin as a Service","item":"http://localhost:1313/posts/2024/10/spam-assassin-as-a-service/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Spam Assassin as a Service","name":"Spam Assassin as a Service","description":"Making SpamAssassin available through an API","keywords":["API","docker"],"articleBody":"\nHello world!\nIn this post I’m sharing a fun project I had to deliver for a much larger project: A Spam detector available as an API.\nWhat are the requirements? The span detector that I was tasked to create is part of a much larger system. Basically, the need is to test if an outbound email can be assymiled to a spam, before sending the email.\nThe #1 open source solution for spam detection is Spam Assassin. The question then is to make Spam Assassin available as an API.\nThe overall architecture is like the following:\nBasically, our user queries the Docker container that will forward the query to our FastAPI server. It will then send the content of the email to SpamAssassin to get the score of the email and a report. This will be sent to our original user in a nice JSON format.\nSounds good? Let’s get started…\nThe application Let’s start by the docker image. Starting with an Ubuntu image, we install the necessary tools, most importantly SpamAssassin and Python for server API.\nFROM ubuntu:22.04 # Prevent interactive prompts during package installation ENV DEBIAN_FRONTEND=noninteractive RUN apt-get update \u0026\u0026 apt-get install -y \\ spamassassin \\ spamc \\ python3 \\ python3-pip \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* COPY requirements.txt . RUN pip3 install --no-cache-dir -r requirements.txt # Create app directory and cd into it WORKDIR /app COPY . . # This updates SpamAssassin rules RUN sa-update RUN mkdir /var/run/spamd CMD [\"sh\", \"-c\", \"spamd --allow-tell --create-prefs --max-children 5 --helper-home-dir /var/lib/spamassassin -u debian-spamd \u0026 python3 app.py\"] EXPOSE 5000 NOTA: This is a simple and not optimized docker image. Consider it for education purpose only, adapt it for production.\nThe rest is just basic configuration, nothing obscure under the sun, except for the CMD in which we start SpamAssassin daemon and the Python server.\nBuilding and running the docker container is done with the following:\ndocker build -t spam-detector . docker run --rm -p 5000:5000 spam-detector This will expose the whole application through port 5000.\nFor the Python server, I used FastAPI, with only two REST endpoints:\nPOST /check to check if the email is a Spam GET /up as a health check I’m using Pydantic to ensure typing, especially we are handling a JSON input, and returning a JSON too:\nfrom fastapi import FastAPI, HTTPException from pydantic import BaseModel import subprocess import tempfile import os app = FastAPI(title=\"SpamAssassin as a Service\") class EmailMessage(BaseModel): content: str threshold: float = 5.0 # Default spam score threshold class SpamResponse(BaseModel): is_spam: bool spam_score: float report: str @app.post(\"/check\", response_model=SpamResponse) async def check_spam(email: EmailMessage): try: # Create temporary file for email content with tempfile.NamedTemporaryFile(mode='w+', delete=False) as temp_file: temp_file.write(email.content) temp_file_path = temp_file.name # Run SpamAssassin check result = subprocess.run( ['spamc', '-c', temp_file_path], capture_output=True, text=True ) # Get detailed report report = subprocess.run( ['spamc', '-R', temp_file_path], capture_output=True, text=True ) # Clean up temporary file os.unlink(temp_file_path) # Parse spam score from report try: spam_score = float(result.stdout.strip()) except ValueError: spam_score = 0.0 return SpamResponse( is_spam=spam_score \u003e= email.threshold, spam_score=spam_score, report=report.stdout ) except Exception as e: raise HTTPException(status_code=500, detail=str(e)) @app.get(\"/up\") async def health_check(): try: # Check if SpamAssassin daemon is running subprocess.run(['pgrep', 'spamd'], check=True) return {\"status\": \"healthy\"} except subprocess.CalledProcessError: raise HTTPException(status_code=503, detail=\"SpamAssassin daemon is not running\") The POST /check endpoints expects a JSON body with the following information:\ncontent which is the content of the email we want to send threshold which is a floating number that scores the “spaminess” of our message. Basically, SpamAssassin will give the message a score based on some criteria, for example: 2.0 BODY: Contains ‘click here’ 3.2 BODY: Excessive use of uppercase text 2.7 MONEY: Mentions large sum of money 4.5 SCAM: Typical prize scam phraseology 2.1 FREEPRIZE: Contains ‘free’ and ‘prize’ 2.1 CREDIT_CARD: Asks for credit card details By default we set the threshold to 5 if not provided by the body, but it can be customized for every query. It means that if the score given by SpamAssassin reaches or exceeds the threshold, it is marked as spam.\nIn our server, the JSON output is like the following:\n{ \"is_spam\": false, \"spam_score\": 0.3, \"report\": \"* -0.0 BODY: Human generated mail text * 0.2 BODY: Contains business-related terms * 0.1 BODY: Contains formal greeting and signature SpamAssassin Score: 0.3 points Status: HAM (threshold 5.0)\" } The nice thing is that SpamAssassin provides a report for its scoring. I really liked this because it can give explanations for a user on why his email is detected as a Spam.\nHealth check is testable with:\ncurl http://localhost:5000/up and spam detection though:\ncurl -X POST \"http://localhost:5000/check\" \\ -H \"Content-Type: application/json\" \\ -d '{\"content\": \"Buy now! Limited time offer!\", \"threshold\": 5.0}' Finally, here is the minimal requirements.txt:\nfastapi\u003e=0.68.0 uvicorn\u003e=0.15.0 pydantic\u003e=1.8.2 python-multipart\u003e=0.0.5 Those packages will be installed in the Docker image on build.\nTake away This was really fun because I learned what makes an email a Spam. It’s a nice and cheap internal solution, but I can imagine that a large scale service of Spam-detection-as-a-service is much more complex.\nSpamAssassin is not bullet proof. But again, this was a nice first step for teams that send emails in big volumes and don’t want them to be marked as spams.\nOther solutions involve specialized SaaS applications or using LLMs to categorize messages, but those solutions can quickly get expensive depending on the emails volume.\nSee you soon.\nHassen\n","wordCount":"887","inLanguage":"en","datePublished":"2024-10-22T08:01:15+01:00","dateModified":"2024-10-22T08:01:15+01:00","author":{"@type":"Person","name":"Hassen"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/2024/10/spam-assassin-as-a-service/"},"publisher":{"@type":"Organization","name":"Hassen Taidirt","logo":{"@type":"ImageObject","url":"http://localhost:1313/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Hassen.io (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Hassen.io</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Spam Assassin as a Service</h1><div class=post-meta><span title='2024-10-22 08:01:15 +0100 +0100'>October 22, 2024</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;887 words&nbsp;·&nbsp;Hassen&nbsp;|&nbsp;<a href=https://github.com/HassenIO/hassen.io/posts/2024/10/spam-assassin-as-a-service.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p><img alt="Just Gmail" loading=lazy src=/2024/10/unsplash-gmail.jpg title="Just Gmail"></p><p>Hello world!</p><p>In this post I&rsquo;m sharing a fun project I had to deliver for a much larger project: A Spam detector available as an API.</p><h2 id=what-are-the-requirements>What are the requirements?<a hidden class=anchor aria-hidden=true href=#what-are-the-requirements>#</a></h2><p>The span detector that I was tasked to create is part of a much larger system. Basically, the need is to test if an outbound email can be assymiled to a spam, before sending the email.</p><p>The #1 open source solution for spam detection is <a href=https://spamassassin.apache.org/>Spam Assassin</a>. The question then is to make Spam Assassin available as an API.</p><p>The overall architecture is like the following:</p><p><img alt="System Architecture of SpamAssassin with FastAPI server" loading=lazy src=/2024/10/system-architecture.png title="System Architecture of SpamAssassin with FastAPI server"></p><p>Basically, our user queries the Docker container that will forward the query to our FastAPI server. It will then send the content of the email to SpamAssassin to get the score of the email and a report. This will be sent to our original user in a nice JSON format.</p><p>Sounds good? Let&rsquo;s get started&mldr;</p><h2 id=the-application>The application<a hidden class=anchor aria-hidden=true href=#the-application>#</a></h2><p>Let&rsquo;s start by the docker image. Starting with an Ubuntu image, we install the necessary tools, most importantly SpamAssassin and Python for server API.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> ubuntu:22.04</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Prevent interactive prompts during package installation</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> <span class=nv>DEBIAN_FRONTEND</span><span class=o>=</span>noninteractive
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> apt-get install -y <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    spamassassin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    spamc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    python3 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    python3-pip <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> requirements.txt .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> pip3 install --no-cache-dir -r requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Create app directory and cd into it</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># This updates SpamAssassin rules</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> sa-update<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> mkdir /var/run/spamd<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;sh&#34;</span><span class=p>,</span> <span class=s2>&#34;-c&#34;</span><span class=p>,</span> <span class=s2>&#34;spamd --allow-tell --create-prefs --max-children 5 --helper-home-dir /var/lib/spamassassin -u debian-spamd &amp; python3 app.py&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 5000</span><span class=err>
</span></span></span></code></pre></div><blockquote><p>NOTA: This is a simple and not optimized docker image. Consider it for education purpose only, adapt it for production.</p></blockquote><p>The rest is just basic configuration, nothing obscure under the sun, except for the <code>CMD</code> in which we start SpamAssassin daemon and the Python server.</p><p>Building and running the docker container is done with the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>docker build -t spam-detector .
</span></span><span class=line><span class=cl>docker run --rm -p 5000:5000 spam-detector
</span></span></code></pre></div><p>This will expose the whole application through port 5000.</p><p>For the Python server, I used FastAPI, with only two REST endpoints:</p><ul><li><code>POST /check</code> to check if the email is a Spam</li><li><code>GET /up</code> as a health check</li></ul><p>I&rsquo;m using Pydantic to ensure typing, especially we are handling a JSON input, and returning a JSON too:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>HTTPException</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tempfile</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span><span class=n>title</span><span class=o>=</span><span class=s2>&#34;SpamAssassin as a Service&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EmailMessage</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>threshold</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>5.0</span>  <span class=c1># Default spam score threshold</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SpamResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>is_spam</span><span class=p>:</span> <span class=nb>bool</span>
</span></span><span class=line><span class=cl>    <span class=n>spam_score</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>report</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/check&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>SpamResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>check_spam</span><span class=p>(</span><span class=n>email</span><span class=p>:</span> <span class=n>EmailMessage</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Create temporary file for email content</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>tempfile</span><span class=o>.</span><span class=n>NamedTemporaryFile</span><span class=p>(</span><span class=n>mode</span><span class=o>=</span><span class=s1>&#39;w+&#39;</span><span class=p>,</span> <span class=n>delete</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span> <span class=k>as</span> <span class=n>temp_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>temp_file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>email</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>temp_file_path</span> <span class=o>=</span> <span class=n>temp_file</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Run SpamAssassin check</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=s1>&#39;spamc&#39;</span><span class=p>,</span> <span class=s1>&#39;-c&#39;</span><span class=p>,</span> <span class=n>temp_file_path</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>capture_output</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>text</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Get detailed report</span>
</span></span><span class=line><span class=cl>        <span class=n>report</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=s1>&#39;spamc&#39;</span><span class=p>,</span> <span class=s1>&#39;-R&#39;</span><span class=p>,</span> <span class=n>temp_file_path</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>capture_output</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>text</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Clean up temporary file</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>unlink</span><span class=p>(</span><span class=n>temp_file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Parse spam score from report</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>spam_score</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>spam_score</span> <span class=o>=</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>SpamResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>is_spam</span><span class=o>=</span><span class=n>spam_score</span> <span class=o>&gt;=</span> <span class=n>email</span><span class=o>.</span><span class=n>threshold</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>spam_score</span><span class=o>=</span><span class=n>spam_score</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>report</span><span class=o>=</span><span class=n>report</span><span class=o>.</span><span class=n>stdout</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/up&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>health_check</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Check if SpamAssassin daemon is running</span>
</span></span><span class=line><span class=cl>        <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=s1>&#39;pgrep&#39;</span><span class=p>,</span> <span class=s1>&#39;spamd&#39;</span><span class=p>],</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;healthy&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>CalledProcessError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=mi>503</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;SpamAssassin daemon is not running&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>The <code>POST /check</code> endpoints expects a JSON body with the following information:</p><ul><li><code>content</code> which is the content of the email we want to send</li><li><code>threshold</code> which is a floating number that scores the &ldquo;spaminess&rdquo; of our message. Basically, SpamAssassin will give the message a score based on some criteria, for example:<ul><li>2.0 BODY: Contains &lsquo;click here&rsquo;</li><li>3.2 BODY: Excessive use of uppercase text</li><li>2.7 MONEY: Mentions large sum of money</li><li>4.5 SCAM: Typical prize scam phraseology</li><li>2.1 FREEPRIZE: Contains &lsquo;free&rsquo; and &lsquo;prize&rsquo;</li><li>2.1 CREDIT_CARD: Asks for credit card details</li></ul></li></ul><p>By default we set the <code>threshold</code> to 5 if not provided by the body, but it can be customized for every query. It means that if the score given by SpamAssassin reaches or exceeds the threshold, it is marked as spam.</p><p>In our server, the JSON output is like the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;is_spam&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;spam_score&#34;</span><span class=p>:</span> <span class=mf>0.3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;report&#34;</span><span class=p>:</span> <span class=s2>&#34;* -0.0 BODY: Human generated mail text
</span></span></span><span class=line><span class=cl><span class=s2>   * 0.2 BODY: Contains business-related terms
</span></span></span><span class=line><span class=cl><span class=s2>   * 0.1 BODY: Contains formal greeting and signature
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>   SpamAssassin Score: 0.3 points
</span></span></span><span class=line><span class=cl><span class=s2>   Status: HAM (threshold 5.0)&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The nice thing is that SpamAssassin provides a report for its scoring. I really liked this because it can give explanations for a user on why his email is detected as a Spam.</p><p>Health check is testable with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl http://localhost:5000/up
</span></span></code></pre></div><p>and spam detection though:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>curl -X POST <span class=s2>&#34;http://localhost:5000/check&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     -H <span class=s2>&#34;Content-Type: application/json&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>     -d <span class=s1>&#39;{&#34;content&#34;: &#34;Buy now! Limited time offer!&#34;, &#34;threshold&#34;: 5.0}&#39;</span>
</span></span></code></pre></div><p>Finally, here is the minimal <strong>requirements.txt</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>fastapi&gt;=0.68.0
</span></span><span class=line><span class=cl>uvicorn&gt;=0.15.0
</span></span><span class=line><span class=cl>pydantic&gt;=1.8.2
</span></span><span class=line><span class=cl>python-multipart&gt;=0.0.5
</span></span></code></pre></div><p>Those packages will be installed in the Docker image on build.</p><h2 id=take-away>Take away<a hidden class=anchor aria-hidden=true href=#take-away>#</a></h2><p>This was really fun because I learned what makes an email a Spam. It&rsquo;s a nice and cheap internal solution, but I can imagine that a large scale service of Spam-detection-as-a-service is much more complex.</p><p>SpamAssassin is not bullet proof. But again, this was a nice first step for teams that send emails in big volumes and don&rsquo;t want them to be marked as spams.</p><p>Other solutions involve specialized SaaS applications or using LLMs to categorize messages, but those solutions can quickly get expensive depending on the emails volume.</p><p>See you soon.</p><p>Hassen</p></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/api/>API</a></li><li><a href=http://localhost:1313/tags/docker/>Docker</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/posts/2024/06/ci-cd-for-rails-8-github-actions-kamal/><span class=title>« Prev</span><br><span>CI/CD pipeline for Rails 8 with Github Actions and Kamal</span>
</a><a class=next href=http://localhost:1313/posts/2023/10/rails-the-force-awaikens/><span class=title>Next »</span><br><span>Rails: The Force Awakens - Why ReactJS Got Left in the Dust</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Spam Assassin as a Service on x" href="https://x.com/intent/tweet/?text=Spam%20Assassin%20as%20a%20Service&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f10%2fspam-assassin-as-a-service%2f&amp;hashtags=API%2cdocker"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Spam Assassin as a Service on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f10%2fspam-assassin-as-a-service%2f&amp;title=Spam%20Assassin%20as%20a%20Service&amp;summary=Spam%20Assassin%20as%20a%20Service&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f10%2fspam-assassin-as-a-service%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Spam Assassin as a Service on reddit" href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f10%2fspam-assassin-as-a-service%2f&title=Spam%20Assassin%20as%20a%20Service"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Spam Assassin as a Service on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f10%2fspam-assassin-as-a-service%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Spam Assassin as a Service on whatsapp" href="https://api.whatsapp.com/send?text=Spam%20Assassin%20as%20a%20Service%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f10%2fspam-assassin-as-a-service%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Spam Assassin as a Service on telegram" href="https://telegram.me/share/url?text=Spam%20Assassin%20as%20a%20Service&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f10%2fspam-assassin-as-a-service%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Spam Assassin as a Service on ycombinator" href="https://news.ycombinator.com/submitlink?t=Spam%20Assassin%20as%20a%20Service&u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2024%2f10%2fspam-assassin-as-a-service%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=http://localhost:1313/>Hassen Taidirt</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>